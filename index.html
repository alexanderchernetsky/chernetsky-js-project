<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet/less" type="text/css" href="style.less"/>
    <title>racing game project</title>
  </head>
  <body>

    <script src="variables.js"></script>

    <div class="game-end-wrapper">
      <p class="info">
        <span>game over!</span><br>
        <span id="score"></span>
      </p>
      <input id="player-name" type="text" placeholder="enter your name"><br>
      <input type="button" value="save result"><br>
      <input type="button" value="high scores"><br>
      <input type="button" value="new game"><br>
      <input type="button" value="main menu"><br>
    </div>
    <div class="game-end-background"></div>

    <div class="wallpaper"></div>
    <div class="buttons-container">
      <input id='game' type="button" value="new game">
      <input id='controls' type="button" value="rules and controls">
      <input id='leaderboard' type="button" value="high scores">
      <input id='about' type="button" value="about">
    </div>

    <div class="controls">
      <input type="button" value="back to menu">
      <p>Rules: move your car to avoid obstacles as long as you can to get a high score.</p>
      <p>Controls: use keyboard arrow keys to move the car.</p>
    </div>

    <div class="leaderboard">
      <input type="button" value="back to menu">
      <table id="score-table">
        <tr>
          <th>Place</th>
          <th>Name</th>
          <th>Score</th>
        </tr>
        <tr id="place-1">
          <td>1</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-2">
          <td>2</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-3">
          <td>3</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-4">
          <td>4</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-5">
          <td>5</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-6">
          <td>6</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-7">
          <td>7</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-8">
          <td>8</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-9">
          <td>9</td>
          <td></td>
          <td></td>
        </tr>
        <tr id="place-10">
          <td>10</td>
          <td></td>
          <td></td>
        </tr>
      </table>
    </div>

    <div class="about">
      <input type="button" value="back to menu">
      <p>Designed and developed by Alexander Chernetsky.</p>
      <p>Mentor - Alexander Stashkevich.</p>
    </div>

    <div class="result-save-window">
      <p>Your result has been recorded!</p>
      <input type="button" value="ok">
    </div>


    <script src="jquery-3.3.1.min.js"></script>
    <script>

      let loaded = false;
      let leaderboardArray;

      function switchToState(state) {
        return location.hash = encodeURIComponent(JSON.stringify(state));
      }
      
      function switchToMainPage() {
        switchToState({page: 'main'});
      }

      function switchToGamePage() {
        switchToState({page: 'game'});
      }
      
      function switchToControlsPage() {
        switchToState({page: 'controls'})
      }
      
      function switchToLeaderboardPage() {
        switchToState({page: 'leaderboard'})
      }

      function switchToAboutPage() {
        switchToState({page: 'about'})
      }

      window.addEventListener('hashchange', renderNewState, false);

      document.getElementById('game').addEventListener('click', switchToGamePage, false);
      document.getElementById('controls').addEventListener('click', switchToControlsPage, false);
      document.getElementById('leaderboard').addEventListener('click', switchToLeaderboardPage, false);
      document.getElementById('about').addEventListener('click', switchToAboutPage, false);

      function renderNewState() {
        let hash = window.location.hash;
        let state = decodeURIComponent(hash.substr(1));
        (state === '') ? (state = {page: 'main'}) : (state = JSON.parse(state));
        switch (state.page) {
          case 'main':
            createMainPage();
            break;
          case 'game':
            createGamePage();
            break;
          case 'controls':
            createControlsPage();
            break;
          case 'leaderboard':
            createLeaderboardPage();
            break;
          case 'about':
            createAboutPage();
            break;
        }
      }

      renderNewState();

      function createMainPage() {
        console.log('main page render');
        document.querySelector('.buttons-container').style.display = 'block';
        document.querySelector('.controls').style.display = 'none';
        document.querySelector('.leaderboard').style.display = 'none';
        document.querySelector('.about').style.display = 'none';
        const canvas = document.getElementsByTagName('canvas')[0];
        if (canvas) {
          document.body.removeChild(canvas);
        }
        document.querySelector('.game-end-wrapper').style.display = 'none';
        document.querySelector('.game-end-background').style.display = 'none';
      }

      function createGamePage() {
        console.log('game page render');
        document.querySelector('.buttons-container').style.display = 'none';
        const canvas = document.getElementsByTagName('canvas')[0];
        if (canvas) {
          document.body.removeChild(canvas);
        }
        document.querySelector('.game-end-wrapper').style.display = 'none';
        document.querySelector('.game-end-background').style.display = 'none';

        if(loaded) {
          startGame();
          return
        }

        $.ajax(
            {
              url: 'game.js',
              type: 'GET',
              cache: true,
              dataType: 'script',
              success: function () {
                console.log('success!!!');
                loaded = true;
                startGame();
              },
              error: errorHandler
            })
      }


      function createControlsPage() {
        console.log('controls page render');
        document.querySelector('.buttons-container').style.display = 'none';
        document.querySelector('.controls').style.display = 'block';
        document.querySelector('.controls input').addEventListener('click', switchToMainPage, false);
      }

      function createLeaderboardPage() {
        console.log('high scores page render');
        document.querySelector('.buttons-container').style.display = 'none';
        document.querySelector('.leaderboard').style.display = 'block';
        document.querySelector('.leaderboard input').addEventListener('click', switchToMainPage, false);
        const canvas = document.getElementsByTagName('canvas')[0];
        if (canvas) {
          document.body.removeChild(canvas);
        }
        document.querySelector('.game-end-wrapper').style.display = 'none';
        document.querySelector('.game-end-background').style.display = 'none';

        refreshLeaderboard();

        function refreshLeaderboard() {
          $.ajax(
              {
                url: "http://fe.it-academy.by/AjaxStringStorage2.php",
                type: 'POST',
                data: {f: 'READ', n: 'CHERNETSKY_RACING_LEADERBOARD'},
                cache: false,
                success: readReady,
                error: errorHandler
              }
          );
        }

        function readReady(ResultH) {
          if (ResultH.error !== undefined)
            alert(ResultH.error);
          else {
            leaderboardArray = [];
            if (ResultH.result !== "") {
              leaderboardArray = JSON.parse(ResultH.result);
              if (!leaderboardArray.length)
                leaderboardArray = [];
            }
            showLeaderboard();
          }
        }

        function showLeaderboard() {
          let ordered = leaderboardArray.sort((first, second) => (+first.score <= +second.score) ? 1 : -1);
          for (let i = 0; i < 10; i++) {
            let onePlayerInfoHash = ordered[i];
            let currentTrElement = document.getElementById(`place-${i + 1}`);
            let currentTdNameEl = currentTrElement.getElementsByTagName('td')[1];
            let currentTdScoreEl = currentTrElement.getElementsByTagName('td')[2];
            currentTdNameEl.innerHTML = `${onePlayerInfoHash.name}`;
            currentTdScoreEl.innerHTML = `${onePlayerInfoHash.score}`;
          }
        }
      }

      function createAboutPage() {
        console.log('about page render');
        document.querySelector('.buttons-container').style.display = 'none';
        document.querySelector('.about').style.display = 'block';
        document.querySelector('.about input').addEventListener('click', switchToMainPage, false);
      }

      function errorHandler(jqXHR, StatusStr, ErrorStr) {
        alert(StatusStr + ' ' + ErrorStr);
      }

      function pushResult() {
        let playerName = document.getElementById('player-name').value;
        if (playerName === '') {
          playerName = 'unknown';
        }
        if (playerName.length > 10) {
          playerName = playerName.substr(0, 10);
        }
        const newResultHash = { name: `${playerName}`, score: `${Math.floor(myGameArea.frameNo / 10)}` };

        let updatePassword;

        sendMessage();

        function sendMessage() {
          updatePassword = Math.random();
          $.ajax(
              {
                url: 'http://fe.it-academy.by/AjaxStringStorage2.php',
                type: 'POST',
                data: {
                  f: 'LOCKGET',
                  n: 'CHERNETSKY_RACING_LEADERBOARD',
                  p: updatePassword,
                },
                cache: false,
                success: lockGetReady,
                error: errorHandler,
              },
          );
        }
        // to get relevant results array from server
        function lockGetReady(resultH) {
          if (resultH.error !== undefined) {
            alert(resultH.error);
          } else {
            leaderboardArray = [];
            if (resultH.result != '') {
              leaderboardArray = JSON.parse(resultH.result);
              leaderboardArray.push(newResultHash);
              if (!leaderboardArray.length) { // if there is a garbage instead of CHERNETSKY_RACING_LEADERBOARD
                leaderboardArray = [];
              }
            }
          }
          // to send results to the server
          $.ajax(
              {
                url: 'http://fe.it-academy.by/AjaxStringStorage2.php',
                type: 'POST',
                data: {
                  f: 'UPDATE',
                  n: 'CHERNETSKY_RACING_LEADERBOARD',
                  v: JSON.stringify(leaderboardArray),
                  p: updatePassword,
                },
                cache: false,
                success: updateReady,
                error: errorHandler,
              },
          );
        }
      }

      function updateReady(resultH) {
        if (resultH.error != undefined) {
          alert(resultH.error);
        } else {
          document.querySelector('.result-save-window').style.display = 'block';
          document.querySelector('.result-save-window input').addEventListener('click', function () {
            document.querySelector('.result-save-window').style.display = 'none';
          }, false)
        }
      }



      /*//the code below is necessary only for the first time to push array with some random players and scores to the server

      let updatePassword;

      
      function sendMessage() {
        updatePassword = Math.random();
        $.ajax(
            {
              url: "http://fe.it-academy.by/AjaxStringStorage2.php",
              type: 'POST',
              data: {
                f: 'LOCKGET',
                n: 'CHERNETSKY_RACING_LEADERBOARD',
                p: updatePassword
              },
              cache: false,
              success: lockGetReady,
              error: errorHandler
            }
        );
      }

      function lockGetReady(resultH) {
        if (resultH.error !== undefined)
          alert(resultH.error);
        else {
          if (resultH.result != "") {
            leaderboardArray = [{name: 'maria', score: '800'}, {name: 'christina', score: '789'}, {name: 'francisco', score: '29'}, {name: 'roland', score: '612'}, {name: 'helen', score: '513'}, {name: 'philip', score: '470'}, {name: 'ivan', score: '88'}, {name: 'giovanni', score: '678'}, {name: 'simon', score: '96'}, {name: 'marie', score: '100'}];
            if (!leaderboardArray.length)
              leaderboardArray = [];
          }

          $.ajax(
              {
                url: "http://fe.it-academy.by/AjaxStringStorage2.php",
                type: 'POST',
                data: {
                  f: 'UPDATE',
                  n: 'CHERNETSKY_RACING_LEADERBOARD',
                  v: JSON.stringify(leaderboardArray),
                  p: updatePassword
                },
                cache: false,
                success: updateReady,
                error: errorHandler
              }
          );
        }
      }

      function updateReady(resultH) {
        if (resultH.error != undefined)
          alert(resultH.error);
      }

      sendMessage();*/

    </script>
    <script src="less.min.js"></script>
  </body>
</html>